name: Continuous Deployment

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "kube/**"

env:
  DOCKER_REGISTRY: ghcr.io
  DOCKER_NAME: vitrine-docker
  DOCKER_TAG: ${{ github.run_id }}
  HELM_NAME: vitrine-helm

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”“ Docker login
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: ðŸ”¨ Git checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: ðŸ“¦ Build Docker image
        run: docker build ./src --tag ${DOCKER_REGISTRY}/${GITHUB_REPOSITORY@L}/${DOCKER_NAME}:${DOCKER_TAG}

      - name: ðŸ“¦ Package Helm chart
        run: helm package ./build/helm --version ${DOCKER_TAG}

      - name: ðŸ“Œ Push Docker image
        run: docker push ${DOCKER_REGISTRY}/${GITHUB_REPOSITORY@L}/${DOCKER_NAME}:${DOCKER_TAG}

      - name: ðŸ“Œ Push Helm chart
        run: helm push ${HELM_NAME}-${DOCKER_TAG}.tgz oci://${DOCKER_REGISTRY}/${GITHUB_REPOSITORY@L}
